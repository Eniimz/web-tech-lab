<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - beDECOR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .checkout-header {
      background: white;
      border-bottom: 1px solid #dee2e6;
      padding: 1.5rem 0;
      margin-bottom: 2rem;
    }
    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
      position: relative;
    }
    .progress-steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #dee2e6;
      z-index: 0;
    }
    .step {
      position: relative;
      z-index: 1;
      text-align: center;
      flex: 1;
    }
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 2px solid #dee2e6;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.5rem;
      font-weight: 600;
      color: #6c757d;
    }
    .step.active .step-circle {
      background: #0d6efd;
      border-color: #0d6efd;
      color: white;
    }
    .step.completed .step-circle {
      background: #198754;
      border-color: #198754;
      color: white;
    }
    .step-label {
      font-size: 0.875rem;
      color: #6c757d;
      font-weight: 500;
    }
    .step.active .step-label {
      color: #0d6efd;
      font-weight: 600;
    }
    .checkout-section {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #f8f9fa;
    }
    .order-summary-card {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .product-item {
      padding: 0.75rem 0;
      border-bottom: 1px solid #f8f9fa;
    }
    .product-item:last-child {
      border-bottom: none;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
    }
    .summary-row.total {
      font-size: 1.25rem;
      font-weight: 700;
      border-top: 2px solid #dee2e6;
      margin-top: 1rem;
      padding-top: 1rem;
    }
    .form-floating label {
      color: #6c757d;
    }
    .payment-option {
      border: 2px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    .payment-option:hover {
      border-color: #0d6efd;
      background: #f8f9ff;
    }
    .payment-option input[type="radio"]:checked + label {
      color: #0d6efd;
      font-weight: 600;
    }
    .payment-option input[type="radio"]:checked ~ .payment-option {
      border-color: #0d6efd;
    }
    .card-details {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #dee2e6;
    }
    .btn-place-order {
      width: 100%;
      padding: 0.75rem;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .btn-place-order:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    @media (min-width: 992px) {
      .order-summary-sticky {
        position: sticky;
        top: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Progress Header -->
  <div class="checkout-header">
    <div class="container">
      <div class="mb-3 text-center">
        <a href="/" class="btn btn-outline-secondary">
          <i class="fas fa-home me-2"></i>Back to Home
        </a>
      </div>
      <div class="progress-steps">
        <div class="step completed">
          <div class="step-circle"><i class="fas fa-check"></i></div>
          <div class="step-label">Cart</div>
        </div>
        <div class="step completed">
          <div class="step-circle"><i class="fas fa-check"></i></div>
          <div class="step-label">Address</div>
        </div>
        <div class="step completed">
          <div class="step-circle"><i class="fas fa-check"></i></div>
          <div class="step-label">Payment</div>
        </div>
        <div class="step active">
          <div class="step-circle">4</div>
          <div class="step-label">Review</div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row g-3">
      <!-- Left Column: Forms -->
      <div class="col-12 col-md-7">
        <!-- Customer & Shipping Form -->
        <div class="checkout-section">
          <h3 class="section-title">
            <i class="fas fa-user me-2"></i>Customer & Shipping Information
          </h3>
          <form id="checkoutForm" method="POST" action="/checkout" novalidate>
            <div class="row g-3">
              <div class="col-12">
                <div class="form-floating">
                  <input type="text" class="form-control" id="fullName" name="fullName" placeholder="Full Name" required>
                  <label for="fullName">Full Name *</label>
                  <div class="invalid-feedback">Please provide your full name.</div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="email" class="form-control" id="email" name="email" placeholder="Email" required>
                  <label for="email">Email Address *</label>
                  <div class="invalid-feedback">Please provide a valid email.</div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="tel" class="form-control" id="phone" name="phone" placeholder="Phone" required pattern="[0-9+\-\s()]+">
                  <label for="phone">Phone Number *</label>
                  <div class="invalid-feedback">Please provide a valid phone number.</div>
                </div>
              </div>
              
              <div class="col-12">
                <div class="form-floating">
                  <input type="text" class="form-control" id="address" name="address" placeholder="Address" required>
                  <label for="address">Street Address *</label>
                  <div class="invalid-feedback">Please provide your address.</div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control" id="city" name="city" placeholder="City" required>
                  <label for="city">City *</label>
                  <div class="invalid-feedback">Please provide your city.</div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control" id="postalCode" name="postalCode" placeholder="Postal Code" required pattern="[A-Za-z0-9\s-]+">
                  <label for="postalCode">Postal Code *</label>
                  <div class="invalid-feedback">Please provide a valid postal code.</div>
                </div>
              </div>
              
              <div class="col-12">
                <div class="form-floating">
                  <select class="form-select" id="country" name="country" required>
                    <option value="">Select Country</option>
                    <option value="US">United States</option>
                    <option value="CA">Canada</option>
                    <option value="UK">United Kingdom</option>
                    <option value="AU">Australia</option>
                    <option value="PK">Pakistan</option>
                    <option value="IN">India</option>
                    <option value="DE">Germany</option>
                    <option value="FR">France</option>
                    <option value="IT">Italy</option>
                    <option value="ES">Spain</option>
                  </select>
                  <label for="country">Country *</label>
                  <div class="invalid-feedback">Please select a country.</div>
                </div>
              </div>
              
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="billingSame" name="billingSame">
                  <label class="form-check-label" for="billingSame">
                    Billing address is the same as shipping address
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>

        <!-- Payment Section -->
        <div class="checkout-section">
          <h3 class="section-title">
            <i class="fas fa-credit-card me-2"></i>Payment Method
          </h3>
          
          <div class="payment-option">
            <input type="radio" class="btn-check" name="paymentMethod" id="paymentCard" value="card" required>
            <label class="form-check-label w-100" for="paymentCard">
              <i class="fas fa-credit-card me-2"></i><strong>Credit/Debit Card</strong>
            </label>
            <div class="card-details" id="cardDetails" style="display: none;">
              <div class="row g-3">
                <div class="col-12">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="cardholderName" name="cardholderName" placeholder="Cardholder Name" pattern="[A-Za-z\s]+">
                    <label for="cardholderName">Cardholder Name</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="cardNumber" name="cardNumber" placeholder="Card Number" pattern="[0-9\s]{13,19}" maxlength="19">
                    <label for="cardNumber">Card Number</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="cardExpiry" name="cardExpiry" placeholder="MM/YY" pattern="[0-9]{2}/[0-9]{2}" maxlength="5">
                    <label for="cardExpiry">Expiry (MM/YY)</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="cardCVV" name="cardCVV" placeholder="CVV" pattern="[0-9]{3,4}" maxlength="4">
                    <label for="cardCVV">CVV</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="payment-option">
            <input type="radio" class="btn-check" name="paymentMethod" id="paymentCOD" value="cod" required>
            <label class="form-check-label w-100" for="paymentCOD">
              <i class="fas fa-money-bill-wave me-2"></i><strong>Cash on Delivery (COD)</strong>
            </label>
          </div>
          
          <div class="payment-option">
            <input type="radio" class="btn-check" name="paymentMethod" id="paymentWallet" value="wallet" required>
            <label class="form-check-label w-100" for="paymentWallet">
              <i class="fas fa-wallet me-2"></i><strong>Digital Wallet</strong>
            </label>
          </div>
        </div>

        <!-- Review & Place Order -->
        <div class="checkout-section">
          <h3 class="section-title">
            <i class="fas fa-clipboard-check me-2"></i>Review & Place Order
          </h3>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="termsCheck" name="termsCheck" required>
            <label class="form-check-label" for="termsCheck">
              I agree to the <a href="#" class="text-decoration-none">Terms and Conditions</a> and <a href="#" class="text-decoration-none">Privacy Policy</a> *
            </label>
            <div class="invalid-feedback">You must agree to the terms to place an order.</div>
          </div>
          <button type="submit" class="btn btn-primary btn-place-order" id="placeOrderBtn" form="checkoutForm" disabled>
            <i class="fas fa-shopping-bag me-2"></i>Place Order
          </button>
        </div>
      </div>

      <!-- Right Column: Order Summary (Sticky on Desktop) -->
      <div class="col-12 col-md-5">
        <div class="order-summary-card order-summary-sticky">
          <h3 class="section-title">
            <i class="fas fa-receipt me-2"></i>Order Summary
          </h3>
          
          <!-- Product List -->
          <div class="mb-3">
            <% if (products.length > 0) { %>
              <% products.forEach(function(product) { %>
                <% const qty = productQuantities[product._id] || 1; %>
                <div class="product-item">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-semibold"><%= product.name %></div>
                      <small class="text-muted">Quantity: <%= qty %></small>
                    </div>
                    <div class="text-end">
                      <div class="fw-semibold">$<%= ((typeof product.price === 'number' ? product.price : Number(product.price)) * qty).toFixed(2) %></div>
                      <small class="text-muted">$<%= (typeof product.price === 'number' ? product.price : Number(product.price)).toFixed(2) %> Ã— <%= qty %></small>
                    </div>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <p class="text-muted text-center">Your cart is empty</p>
            <% } %>
          </div>

          <!-- Coupon Section -->
          <div class="mb-3">
            <label for="couponCode" class="form-label small">Apply Coupon</label>
            <div class="input-group">
              <input type="text" class="form-control" id="couponCode" placeholder="Enter coupon code">
              <button class="btn btn-outline-secondary" type="button" id="applyCoupon">
                <i class="fas fa-tag"></i> Apply
              </button>
            </div>
            <small class="text-muted d-block mt-1">Coupon functionality is for demonstration only</small>
          </div>

          <!-- Summary Totals -->
          <div class="mt-4">
            <div class="summary-row">
              <span>Subtotal</span>
              <span>$<%= subtotal.toFixed(2) %></span>
            </div>
            <div class="summary-row">
              <span>Shipping</span>
              <span>$<%= shipping.toFixed(2) %></span>
            </div>
            <div class="summary-row">
              <span>Tax (10%)</span>
              <span>$<%= tax.toFixed(2) %></span>
            </div>
            <div class="summary-row total">
              <span>Grand Total</span>
              <span>$<%= grandTotal.toFixed(2) %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script>
    // Form validation
    (function() {
      'use strict';
      const form = document.getElementById('checkoutForm');
      const placeOrderBtn = document.getElementById('placeOrderBtn');
      const termsCheck = document.getElementById('termsCheck');
      
      // Enable/disable place order button based on terms checkbox
      termsCheck.addEventListener('change', function() {
        placeOrderBtn.disabled = !this.checked;
      });
      
      // Show/hide card details based on payment method
      const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
      const cardDetails = document.getElementById('cardDetails');
      
      paymentMethods.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'card' && this.checked) {
            cardDetails.style.display = 'block';
          } else {
            cardDetails.style.display = 'none';
          }
        });
      });
      
      // Card number formatting
      const cardNumber = document.getElementById('cardNumber');
      if (cardNumber) {
        cardNumber.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\s/g, '');
          let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
          e.target.value = formattedValue;
        });
      }
      
      // Card expiry formatting
      const cardExpiry = document.getElementById('cardExpiry');
      if (cardExpiry) {
        cardExpiry.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
          }
          e.target.value = value;
        });
      }
      
      // Form submission
      form.addEventListener('submit', function(event) {
        event.preventDefault();
        event.stopPropagation();
        
        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }

        // Get form data
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Show loading state
        placeOrderBtn.disabled = true;
        placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        
        // Submit form to server
        fetch('/checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams(data)
        })
        .then(response => {
          if (response.redirected) {
            window.location.href = response.url;
          } else {
            return response.text();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred. Please try again.');
          placeOrderBtn.disabled = false;
          placeOrderBtn.innerHTML = '<i class="fas fa-shopping-bag me-2"></i>Place Order';
        });
        
        form.classList.add('was-validated');
      }, false);
      
      // Coupon button (non-functional as per requirements)
      document.getElementById('applyCoupon')?.addEventListener('click', function() {
        const couponCode = document.getElementById('couponCode').value;
        if (couponCode) {
          alert('Coupon functionality is for demonstration only. Code: ' + couponCode);
        }
      });
    })();
  </script>
</body>
</html>

